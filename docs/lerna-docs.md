---
title: Lerna
---

[Lerna](https://lerna.js.org/) - это инструмент управления многопакетными репозиториями с открытым исходным кодом. Он позволяет разработчикам управлять несколькими пакетами в одном монорепозитории, включая управление версиями, публикацию, управление зависимостями и сборку.

## Содержание

-   [Установка](#Установка)
-   [Создание нового монорепозитория](#Создание-нового-монорепозитория)
-   [Добавление нового пакета](#Добавление-нового-пакета)
-   [Установка зависимостей](#Установка-зависимостей)
-   [Изменение версии](#Изменение-версии)
-   [Публикация пакета на NPM](#Публикация-пакета-на-NPM)
-   [Использование флагов](#Использование-флагов)
-   [Использование Lerna с Git](#Использование-Lerna-с-Git)
-   [Как добавить/убрать/обновить зависимость в пакетах?](#Как-добавитьубратьобновить-зависимость-в-пакетах)
-   [Как билдить пакеты?](#Как-билдить-пакеты)
-   [Как устанавливать пакеты локально?](#Как-устанавливать-пакеты-локально)
-   [Заключение](#Заключение)

## Установка

Перед использованием **Lerna** необходимо его установить. Вы можете сделать это выполнив одну из следующих команд:

```bash
npm install -g lerna
yarn global add lerna
pnpm install -g lerna
```

## Создание нового монорепозитория

Вы можете создать новый монорепозиторий с помощью следующей команды:

```bash
lerna init
```

Эта команда создаст структуру каталогов для вашего монорепозитория и установит Lerna в него.

## Добавление нового пакета

Вы можете добавить новый пакет в ваш монорепозиторий с помощью следующей команды:

```bash
lerna create <имя нового пакета>
```

Например команда **`lerna create my-package`** создаст каталог **packages/my-package** и заполнит его шаблонными файлами для нового пакета (аналогично если бы вы создали папку **my-package** внутри папки **packages** и выполнили в ней команду инициализации нового проекта, например: **`npm init`**). Вы можете изменить содержимое этих файлов, чтобы адаптировать их под свои нужды.

## Установка зависимостей

~~Чтобы выполнить установку зависимостей выполните команду **`lerna bootstrap`**~~. Начиная с версии `7.0.0`, в **Lerna** удалены устаревшие команды управления пакетами, такие как: **`bootstrap`**, **`add`**, и **`link`**. Вместо них рекомендуется использовать ваш пакетный менеджер (**`npm`**, **`yarn`**, **`pnpm`**) для решения таких задач, как установка и связывание зависимостей.

Теперь для установки зависимости всех пакетов в корне вашего монорепозитория достаточно выполнить одну из следующих команд:

```bash
npm install
pnpm install
yarn
```

Помимо установки, это свяжет все все зависимости между собой, позволив использовать их как зависимости (аналогично если бы вы сделали **`npm link`** в корне каждого пакета, а затем **`npm link <имя пакета>`** в корне монорепозитория).

## Изменение версии

**Lerna** поставляется с командой **`version`**, которая позволяет вам поднять версию вашего пакета, зафиксировать изменения и пометить их соответствующим образом. Чтобы изменить версию всех пакетов, используйте следующую команду:

```bash
lerna version --no-private
```

и вы увидите в терминале следующее:

```bash
lerna notice cli v5.1.2
lerna info current version 1.0.0
lerna info Assuming all packages changed
? Select a new version (currently 1.0.0) (Use arrow keys)
❯ Patch (1.0.1)
Minor (1.1.0)
Major (2.0.0)
Prepatch (1.0.1-alpha.0)
Preminor (1.1.0-alpha.0)
Premajor (2.0.0-alpha.0)
Custom Prerelease
Custom Version
```

Обратите внимание, что передавая **`--no-private`**, мы исключаем все пакеты, которые помечены как приватные в их **package.json**.

Lerna обнаруживает текущие пакеты, определяет текущую версию и предлагает выбрать следующую. Обратите внимание, вы также можете передавать новую версию напрямую, например:

```bash
lerna version 1.0.0
```

После выбора версии **Lerna** обновляет **package.json** с номером версии, фиксирует изменение, добавляет соответствующий тег версии (например, v1.0.0) и переносит коммит и тег в удаленный репозиторий.

Если вы хотите обновить версию определенного пакета, используйте флаг **`--scope`**, например:

```bash
lerna version <version> --scope my-package
```

## Публикация пакета на NPM

Вы можете опубликовать ваши пакеты в **NPM** с помощью следующей команды:

```bash
lerna publish
```

Также вы можете опубликовать пакеты в локальный **NPM** регистр, используя такие утилиты как [**yalc**](https://www.npmjs.com/package/yalc) или [**verdaccio**](https://verdaccio.org/).

## Использование флагов

**Lerna** имеет множество [**флагов**](https://lerna.js.org/docs/api-reference/commands#options), которые позволяют настроить поведение определенных команд. Некоторые из них:

-   **`--scope`**: позволяет работать только с указанным пакетом.
-   **`--ignore`**: позволяет игнорировать указанные пакеты.
-   **`--concurrency`**: позволяет настроить количество параллельных задач.
-   **`--no-private`**: исключает приватны пакеты (они включены по умолчанию).
-   **`--since [ref]`**: включить только те пакеты, которые были изменены после указанного **`ref`** .

## Использование Lerna с Git

Lerna хорошо интегрируется с **Git**. Он может автоматически создавать коммиты и теги для изменений в версии пакетов. Вы можете использовать следующие команды для работы с **Git** в **Lerna**:

-   **`lerna changed`**: показывает пакеты, которые были изменены в последнем коммите.
-   **`lerna diff`**: показывает различия между двумя версиями указанного пакета.
-   **`lerna exec <command> --since <last-version>`**: запускает команду для всех пакетов, которые были изменены с последней версии.

## Как добавить/убрать/обновить зависимость в пакетах?

Для добавления зависимости, которая будет использоваться во всех пакетах можно использовать команды установки ваших пакетных менеджеров. Например если вы хотите установить **[lodash-es](https://www.npmjs.com/package/lodash-es)**, можно использовать одну из следующих команд в корне монорепозитория:

```bash
npm install lodash-es
yarn add lodash-es
pnpm install lodash-es
```

Если вы хотите добавить зависимость только для определенного пакета, нужно обратиться к документации вашего пакетного менеджера. Например, если вы хотите добавить зависимость **react** только для пакета **my-package**, вы можете выполнить одну из следующих команд:

```bash
yarn workspace <имя пакета> add react
pnpm add react --filter=<имя пакета>
npm install react --workspace=<имя пакета>
```

Удаление зависимости происходит таким же образом:

```bash
yarn workspace <имя пакета> remove react
pnpm remove react --filter=<имя пакета>
npm remove react --workspace=<имя пакета>
```

Обновление зависимостей также зависит от особенностей вашего пакетного менеджера. Например **`yarn`** есть своя система **[плагинов](https://yarnpkg.com/features/plugins)**, один из которых позволяет выполнять интерактивное обновление каждой зависимости в вашем монорепозитории. Так выполнив команду **`yarn upgrade-interactive`**, в терминале вы увидите предложенный выбор обновления зависимостей наподобие этого:

```bash
Press <up>/<down> to select packages.            Press <enter> to install.
Press <left>/<right> to select versions.         Press <ctrl+c> to abort.

? Pick the packages you want to upgrade.          Current          Range

 > @commitlint/cli ----------------------------- ◉ ^17.6.3 ------ ◯ ^17.6.6
   @commitlint/config-conventiona -------------  ◉ ^17.6.3 ------ ◯ ^17.6.6
   @types/underscore --------------------------- ◉ ^1.11.4 ------ ◯ ^1.11.5
   @typescript-eslint/eslint-plugin ------------ ◉ ^5.59.7 ------ ◯ ^5.61.0
   @typescript-eslint/parser ------------------- ◉ ^5.59.7 ------ ◯ ^5.61.0
   @vitest/coverage-c8 ------------------------- ◉ ^0.31.1 ------ ◯ ^0.31.4
   eslint -------------------------------------- ◉ ^8.41.0 ------ ◯ ^8.44.0
   lerna --------------------------------------- ◉ ^6.6.2 ------- ◯ ^7.1.1
   lint-staged --------------------------------- ◉ ^13.2.2 ------ ◯ ^13.2.3
   mermaid ------------------------------------- ◉ 10.1.0 ------- ◯ 10.2.4
   prettier ------------------------------------ ◉ ^2.8.8 ------- ◯ ^3.0.0
   typescript ---------------------------------- ◉ ^5.0.4 ------- ◯ ^5.1.6
   vitest -------------------------------------- ◉ ^0.31.1 ------ ◯ ^0.31.4
```

Для **`npm`** и **`pnpm`** есть аналог - **[npm-check](https://www.npmjs.com/package/npm-check)**. Для того запустить интерактивный пользовательский интерфейс выбора зависимостей для обновления сперва установите утилиту:

```bash
# локально, как dev-зависимость
npm install npm-check -D
yarn add npm-check -D
pnpm install npm-check -D

# или глобально
npm install npm-check -g
yarn global add npm-check
pnpm install npm-check -g
```

и запустите ее в корне вашего монорепозитория с флагом **`--update`**:

```bash
npm-check --update
```

В терминале появится интерактивный интерфейс схожий с интерфейсом обновления **`yarn upgrade-interactive`**.

## Как билдить пакеты?

**Lerna** позволяет легко билдить все пакеты в монорепозитории. Вы можете использовать команду **`lerna run build`**, чтобы выполнить команду **`build`** для каждого пакета в монорепозитории. Например, если вы хотите сбилдить все пакеты в монорепозитории, вы можете выполнить следующую команду:

```bash
lerna run build
```

Если вы хотите сбилдить только определенный пакет, вы можете использовать флаг **`--scope`**. Например, если вы хотите собрать только определенный пакет, вы можете выполнить следующую команду:

```bash
lerna run build --scope @monorepo/my-package-name
```

ВАЖНО! Указывайте только имя указанное в поле **name** в **package.json** пакета с которым вы хотите взаимодействовать.

**Lerna** также позволяет определять специфические скрипты для каждого пакета в монорепозитории. Для этого в файле **`package.json`** каждого пакета можно добавить скрипты с префиксом **`lerna`** (например, **`lerna:build`**). Затем вы можете использовать команду **`lerna run`** для запуска этих скриптов для всех пакетов в монорепозитории.

## Как устанавливать пакеты локально?

После того, как вы сбилдили свои пакеты, вы можете использовать их в других проектах, подключив их как зависимости. В зависимости от того, где располагается ваш монорепозиторий, вы можете использовать различные способы для установки зависимостей. Если вы используете пакеты в том же монорепозитории (например для других пакетов в папке **packages/**). То можно просто указать **`*`** в качестве источника пакета например:

```json
{
	"dependencies": {
		"my-package": "*"
	}
}
```

Если вы собираетесь использовать пакет в других проектах в локальном пространстве, вы можете использовать команды **`npm link`**, **`yarn link`** или **`pnpm link`** чтобы установить сбилженные пакеты в другой проект. Например, если вы хотите подключить пакет **my-package** из вашего монорепозитория в другой проект, вы можете выполнить следующие команды:

```bash
cd packages/my-package
npm link
cd /путь/до/другого/проекта
npm link my-package
```

Эти команды создадут символическую ссылку на пакет **my-package** в другом проекте, используя установленный пакет локально на вашем компьютере.

## Заключение

Это был краткий гайд основных фишек и команд **Lerna**, которые могут помочь вам при работе с монорепозиториями. **Lerna** может значительно упростить процесс разработки и управления зависимостями в больших проектах, так что, если вы работаете над проектом, который может быть организован в монорепозиторий, рекомендуется изучить Lerna более подробно в [официальной документации](https://lerna.js.org/docs/introduction).
